<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="timeline_d3.js"></script>
    <style>
      
    #dashboard {
      /* border: solid 1px black; */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: #f8f8f8;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      z-index: 10;
      
    }
    #axis-container {
      position: fixed;
      top: 52px;
      left: 20;
      width: 100%;
      height: 40px;
      background-color: #f8f8f8;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }
    #chart-container {
      border: solid 1px black;
        /* position: relative; */
        width: 100%;
        /* overflow-x: auto; */
        overflow-y: scroll;
        margin-top: 60px; 
    }
    #searchButton { 
      border: solid 1px black;
      background-color: #fde0dd; /* Green */
      border: none;
      color: black;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      cursor: pointer;
    }


  </style>
</head>
<body>
  <!-- Dashboard Section -->
  <div id="dashboard">
    <b>Data with verified: </b>
    
    <input type="checkbox" id="knownLifespan" value = "knownLifespan" checked  onclick="toggleCheckboxOnAndOff(this)">
    <label for="knownLifespan">Lifespan</label>
    
    <input type="checkbox" id="knownBirth" value = "knownBirth" checked  onclick="toggleCheckboxOnAndOff(this)">
    <label for="knownBirth">Birth year</label>
    
    <input type="checkbox" id="knownDeath" value = "knownDeath" checked  onclick="toggleCheckboxOnAndOff(this)">
    <label for="knownDeath">Death year</label>
    
    <input type="checkbox" id="none" value = "none" checked  onclick="toggleCheckboxOnAndOff(this)">
    <label for="none">None (neither birth or death is known)<br>
    
    <input type="search" id="searchInput" value = "">
    <input type="button" id="searchButton"  value = "Search!" onclick="toggleSearch(this)">
    <!-- <label for="endDate">End Date:</label>
    <input type="date" id="endDate"> -->

    <!-- <button onclick="filterTimeline()">Apply Filter</button> -->
  </div>

<div id="axis-container">
  </div>

<div id="chart-container">
  </div>
<script>
    const LIFESPAN_MEAN = 57.25;
    const LIFESPAN_STD = 17.3349;
    const LIFESPAN_NUM_UNSURE = 570;
    const Key_Years_Range = {"EastHan":[184, 220], "Wei":[220, 266], "Shu":[221, 263],"Wu":[222, 280], "Jin":[266, 316],"EastJin":[317, 420]};
    const simulatedData = generateNormalDistribution(LIFESPAN_MEAN, LIFESPAN_STD, LIFESPAN_NUM_UNSURE);

    var i = 0; // iterator for simulatedData

    // Load CSV data and create timeline visualization
    d3.csv("Sanguo_CharacterRecord.csv").then(function(data) {
      data.forEach(d=>{
        if(/^\d+$/.test(d.Birth_year)  && /^\d+$/.test(d.Death_year ))
        { 
          d.Birth_year = Number(d.Birth_year);
          d.Death_year = Number(d.Death_year);
          d.Type = "birthAndDeath";
        }
        else if(/^\d+$/.test(d.Birth_year))
        {
          d.Birth_year = Number(d.Birth_year);
          d.Death_year = d.Birth_year + simulatedData[i++];
          d.Type = "birthOnly";
        }
        else if(/^\d+$/.test(d.Death_year))
        {
          d.Death_year = Number(d.Death_year);
          d.Birth_year = d.Death_year - simulatedData[i++];
          d.Type = "deathOnly";
        }
        else //If neither birth nor death are known, generate a random live year that align with the individual's living time
        {
          d.Live_year = getRandomInt(Key_Years_Range[d.Dynasty][0], Key_Years_Range[d.Dynasty][1]);
          d.Type = "noBirthOrDeath";
        }
      });

      var timelineData = data;
      // --- The process of csv data is done. "data" is a list, each entry is a dict with 15 attributes:
      // --- #Name_cn	ID  Last_Name	Zi	Name_en	Affiliation Dynasty Birth_year	Death_year	Lifespan	Father	Father_ID	Native_place	Jun	Xian	Note

    /*
      --- Load the family tree data from the familytree json file
    */
    fetch('familytree.json')
      .then(response => response.json())
      .then(function(data) {

        // --- familytreeRoots is a list that stores all the roots of familytrees.
        //familytreeRoots = [];

        // --- familytreeDicts is a dict, stores the corresponding root for each individuals, 
        // --- if there is one
        familytreeDicts = {};
        data.forEach(d => {
          var theDict = {}
          var root = d3.hierarchy(d);
          var allNodeIds = root.descendants().map(node => node.data.value);
          //familytreeRoots.push(root);
          for(var i = 0, size = allNodeIds.length; i < size ; i++){
            theDict[allNodeIds[i]] = root;
            }
          
          familytreeDicts = {...familytreeDicts, ...theDict};
        });
        //Familytree(data);
        Timeline(timelineData, familytreeDicts);
        //setTimeout(scrollToBottom, 100);
      })

    // Append the SVG to a specific HTML element
    // const targetElement = document.getElementById("timeline");
    // targetElement.appendChild(svgElement);  
    });

    function toggleCheckboxOnAndOff(checkboxButton)
    {
      if (checkboxButton.id == "knownLifespan")
          updateTimelineData(checkboxButton.checked, "birthAndDeath");
      if (checkboxButton.id == "knownBirth")
          updateTimelineData(checkboxButton.checked, "birthOnly");
      if (checkboxButton.id == "knownDeath")
          updateTimelineData(checkboxButton.checked, "deathOnly");
      if (checkboxButton.id == "none")
          updateTimelineData(checkboxButton.checked, "noBirthOrDeath");

    }

    function toggleSearch()
    {
      searchIndividual(document.getElementById('searchInput').value);
    }
</script>

</body>
</html>
<!DOCTYPE HTML>
<!-- 
  TODO:
    1.  There is bug about changing color when click timeline bars √
    2.  Add functions to dashboard selection √

    21/11
    1.  Add text to points √
    2.  Add the interconnect function between timeline and family tree - Half Done


    1. enable zoom and pan √
    2. fix x axis √
    3. Repos screen when click a treenode √

    22/11
    1. Click white space to exit tree view √
    2. Attach all functions to points √
    3. Disable timeline interaction when treeview is on √

    23/11
    1. animation from timeline to tree
    2. Color coding √
    3. Move title to the middle of the bar √
    4. Add search function √
    5. Add gender filter

    future: cluster people that has close relationship
 -->
<html>